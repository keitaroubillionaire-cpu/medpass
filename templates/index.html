{% extends "base.html" %}

{% block title %}ダッシュボード - MedPass{% endblock %}

{% block content %}
<h1>ダッシュボード</h1>

<div class="stats-grid">
    <div class="stat-card">
        <h3>科目数</h3>
        <p class="stat-number">{{ total_subjects }}</p>
    </div>
    <div class="stat-card">
        <h3>講義数</h3>
        <p class="stat-number">{{ total_lectures }}</p>
    </div>
    <div class="stat-card">
        <h3>カード数</h3>
        <p class="stat-number">{{ total_cards }}</p>
    </div>
    <div class="stat-card">
        <h3>問題数</h3>
        <p class="stat-number">{{ total_questions }}</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>合格確率予測</h2>
    <div class="pass-probabilities">
        <div class="prob-card prob-90">
            <div class="prob-label">90点到達</div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: {{ pass_stats.prob_90 }}%"></div>
            </div>
            <div class="prob-value">{{ pass_stats.prob_90 }}%</div>
        </div>
        <div class="prob-card prob-80">
            <div class="prob-label">80点到達</div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: {{ pass_stats.prob_80 }}%"></div>
            </div>
            <div class="prob-value">{{ pass_stats.prob_80 }}%</div>
        </div>
        <div class="prob-card prob-60">
            <div class="prob-label">60点到達（合格ライン）</div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: {{ pass_stats.prob_60 }}%"></div>
            </div>
            <div class="prob-value">{{ pass_stats.prob_60 }}%</div>
        </div>
    </div>
    <div class="study-stats">
        <p>現在のスコア: <strong>{{ pass_stats.weighted_score }}点</strong>（重要度加重平均）</p>
        <p>学習進捗: <strong>{{ pass_stats.studied_count }}/{{ pass_stats.total_count }}問</strong>（{{ pass_stats.coverage }}%）</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>Next 5 - 次に勉強すべき問題</h2>
    {% if next_questions %}
    <ul class="question-list">
        {% for question in next_questions %}
        <li>
            <a href="/questions?card_id={{ question.card_id }}">
                {{ question.question_text[:50] }}{% if question.question_text|length > 50 %}...{% endif %}
            </a>
            {% if question.card %}
            <span class="tag">{{ question.card.theme }}</span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty-state">まだ問題がありません。講義からカードと問題を作成してください。</p>
    {% endif %}
</div>

<div class="dashboard-section">
    <h2>未出テーマ（過去問なし）</h2>
    {% if uncovered_themes %}
    <p class="section-desc">過去問がまだ紐付いていないテーマです。新問として出題される可能性があります。</p>
    <ul class="theme-list">
        {% for card in uncovered_themes %}
        <li>
            <a href="/questions?card_id={{ card.id }}">{{ card.theme }}</a>
            <span class="importance">{{ "★" * card.importance }}{{ "☆" * (3 - card.importance) }}</span>
            {% if card.lecture %}
            <span class="tag">{{ card.lecture.subject.name }}</span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty-state">全てのテーマに過去問が紐付いています。素晴らしい！</p>
    {% endif %}
</div>

<div class="dashboard-section">
    <h2>科目別 過去問カバレッジ</h2>
    {% if subject_coverage %}
    <div class="coverage-list">
        {% for item in subject_coverage %}
        <div class="coverage-item">
            <div class="coverage-info">
                <a href="/subjects/{{ item.subject.id }}">{{ item.subject.name }}</a>
                <span class="coverage-detail">{{ item.covered_cards }}/{{ item.total_cards }}テーマ</span>
            </div>
            <div class="coverage-bar-container">
                <div class="coverage-bar">
                    <div class="coverage-fill {% if item.coverage_pct >= 80 %}high{% elif item.coverage_pct >= 50 %}mid{% else %}low{% endif %}" style="width: {{ item.coverage_pct }}%"></div>
                </div>
                <span class="coverage-pct">{{ item.coverage_pct }}%</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">科目を追加してカードを作成すると、ここにカバレッジが表示されます。</p>
    {% endif %}
</div>

<div class="dashboard-section">
    <h2>最近の科目</h2>
    {% if subjects %}
    <ul class="subject-list">
        {% for subject in subjects %}
        <li>
            <a href="/subjects/{{ subject.id }}">{{ subject.name }}</a>
            <span class="count">{{ subject.lectures|length }}講義</span>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty-state">まだ科目がありません。<a href="/subjects">科目を追加</a>してください。</p>
    {% endif %}
</div>
{% endblock %}
